<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/admin-home"></ion-back-button>
    </ion-buttons>
    <ion-title>Track Parcel</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="tracking-container">
    <h1 class="tracking-title">Track Your Parcel</h1>
    <p class="subtitle ion-text-center">Enter your tracking ID to check status and location</p>

    <div class="search-container">
      <ion-item class="search-bar">
        <ion-input 
          placeholder="Enter Tracking ID" 
          [(ngModel)]="trackingId"
          (keyup.enter)="trackParcel()"
        ></ion-input>
        <ion-button slot="end" class="search-button" (click)="trackParcel()">
          <ion-icon name="search-outline"></ion-icon>
        </ion-button>
      </ion-item>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <ion-spinner name="circles"></ion-spinner>
      <p>Searching for your parcel...</p>
    </div>

    <!-- Not Found State -->
    <ion-card *ngIf="searchPerformed && !loading && !parcel" class="error-card">
      <ion-card-header>
        <ion-card-title color="danger">Parcel Not Found</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p>No parcel found with ID: <strong>{{ trackingId }}</strong></p>
        <p>Please verify and try again.</p>
      </ion-card-content>
    </ion-card>

    <!-- Parcel Details -->
    <ion-card *ngIf="parcel && !loading" class="parcel-card">
      <ion-card-header>
        <ion-card-subtitle>Tracking Number</ion-card-subtitle>
        <ion-card-title>{{ parcel.trackingId }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <!-- Progress Tracker -->
        <div class="progress-tracker">
          <div class="progress-step" [ngClass]="{'active': isEventActive('Registered')}">
            <div class="step-icon">
              <ion-icon name="create-outline"></ion-icon>
            </div>
            <div class="step-label">Pickup</div>
          </div>
          <div class="progress-line" [ngClass]="{'active': isEventActive('In Transit')}"></div>
          <div class="progress-step" [ngClass]="{'active': isEventActive('In Transit')}">
            <div class="step-icon">
              <ion-icon name="airplane-outline"></ion-icon>
            </div>
            <div class="step-label">Delivering</div>
          </div>
          <div class="progress-line" [ngClass]="{'active': isEventActive('Delivered')}"></div>
          <div class="progress-step" [ngClass]="{'active': isEventActive('Delivered')}">
            <div class="step-icon">
              <ion-icon name="checkmark-circle-outline"></ion-icon>
            </div>
            <div class="step-label">Delivered</div>
          </div>
        </div>

        <!-- Sender/Receiver Info -->
        <div class="sender-receiver-compact">
          <div class="info-pair">
            <div class="info-col">
              <h4 class="info-title">Sender</h4>
              <p class="info-name">{{ parcel.senderName || 'Unknown' }}</p>
              <p class="info-contact" *ngIf="parcel.senderContact">{{ parcel.senderContact }}</p>
            </div>
            <div class="info-divider"></div>
            <div class="info-col">
              <h4 class="info-title">Receiver</h4>
              <p class="info-name">{{ parcel.receiverName || 'Unknown' }}</p>
              <p class="info-contact" *ngIf="parcel.receiverContact">{{ parcel.receiverContact }}</p>
            </div>
          </div>
        </div>

        <!-- Map (Hidden if Delivered or Photo Available) -->
        <div class="map-container" *ngIf="parcel && mapCoordinates && parcel.status !== 'Delivered' && !parcel.photoURL">
          <div class="map-header" style="display: flex; align-items: center; justify-content: space-between; padding: 0 16px 0 16px;">
            <h3 style="margin: 0;">Delivery Route</h3>
            <button class="open-map-btn" (click)="openExternalMap()" aria-label="Open in Map">
              <div class="real-time-indicator" *ngIf="isLocationTracking">
                <span class="pulse-dot"></span>
                <span>LIVE</span>
              </div>
              <ion-icon name="map-outline"></ion-icon>
              <span>Open Map</span>
            </button>
          </div>
          <div class="map-wrapper">
            <div #mapElement class="map-element"></div>
            <div class="map-overlay" *ngIf="!mapLoaded">
              <ion-spinner name="dots"></ion-spinner>
              <p>Loading map...</p>
            </div>
            <div class="map-error" *ngIf="mapLoaded && !map">
              <p>Unable to load map.</p>
            </div>
            <!-- Track Location Button -->
            <div class="map-controls" *ngIf="isLocationTracking">
              <button class="track-location-btn" (click)="centerOnCurrentLocation()">
                <ion-icon name="locate-outline"></ion-icon>
                <span>Track Location</span>
              </button>
            </div>
            <div class="map-status-overlay" *ngIf="hubModeActive">
              <div class="hub-status">
                <ion-icon name="business-outline"></ion-icon>
                <span>Parcel is at distribution center</span>
              </div>
            </div>
          </div>
          <div class="destination-info">
            <div class="destination-icon">
              <ion-icon name="location-outline"></ion-icon>
            </div>
            <div class="destination-details">
              <p class="destination-title">Destination</p>
              <p class="destination-address">{{ parcel.receiverAddress || 'Unknown' }}</p>
            </div>
          </div>
          <div class="tracking-status" *ngIf="isLocationTracking && lastLocationUpdate">
            <ion-icon [name]="hubModeActive ? 'business-outline' : 'sync-outline'" [class]="hubModeActive ? '' : 'pulse'"></ion-icon>
            <div class="tracking-status-text">
              <p class="status-title">
                <ng-container *ngIf="!hubModeActive">
                  Real-time tracking active
                  <span *ngIf="currentDeliverymanName"> with {{ currentDeliverymanName }}</span>
                </ng-container>
                <ng-container *ngIf="hubModeActive">
                  Parcel at distribution center
                </ng-container>
              </p>
              <p class="status-time">Last updated: {{ formatDate(lastLocationUpdate) }}</p>
            </div>
          </div>
        </div>

        <!-- Delivery Confirmation -->
        <div class="delivery-confirmation" *ngIf="parcel && (parcel.status === 'Delivered' || parcel.photoURL)">
          <ion-icon name="checkmark-circle" color="success"></ion-icon>
          <h3>Delivered</h3>
          <p>Parcel successfully delivered and verified.</p>
          <div class="delivery-photo" *ngIf="parcel.photoURL">
            <img [src]="parcel.photoURL" alt="Verification Photo">
          </div>
        </div>

        <!-- Delivery Estimation -->
        <div class="delivery-estimation" *ngIf="parcel && estimatedDelivery && parcel.status !== 'Delivered'">
          <div class="estimation-header">
            <ion-icon name="time-outline"></ion-icon>
            <h3>Estimated Delivery</h3>
          </div>
          <div class="estimation-content">
            <div class="estimated-date">
              <div class="date-label">Expected by</div>
              <div class="date-value">{{ estimatedDelivery.formattedDate }}</div>
            </div>
            <div class="estimation-details">
              <div class="detail-item">
                <ion-icon name="calendar-outline"></ion-icon>
                <span>{{ estimatedDelivery.dayOfWeek }}</span>
              </div>
              <div class="detail-item" *ngIf="estimatedDelivery.timeWindow">
                <ion-icon name="time-outline"></ion-icon>
                <span>{{ estimatedDelivery.timeWindow }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Location Timeline -->
        <div class="delivery-timeline">
          <h3>Location History</h3>
          <div class="timeline">
            <div class="timeline-event" 
                 *ngFor="let event of trackingEvents; let i = index"
                 [ngClass]="{'active': event.active !== false}"
                 style="--animation-order: {{i}};">
              <div class="timeline-icon" [ngClass]="{'active': event.active !== false}">
                <ion-icon [name]="getStatusIcon(event.status)"></ion-icon>
              </div>
              <div class="timeline-content">
                <div class="event-header">
                  <h4>{{ event.title }}</h4>
                  <span class="event-time">{{ formatDate(event.timestamp) }}</span>
                </div>
                
                <!-- Only show location and handler information -->
                <p class="event-location" *ngIf="event.location">
                  <ion-icon name="location-outline"></ion-icon> {{ event.location }}
                </p>
                <p class="event-agent" *ngIf="event.deliverymanName">
                  <ion-icon name="person-outline"></ion-icon> Handled by: {{ event.deliverymanName }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content>
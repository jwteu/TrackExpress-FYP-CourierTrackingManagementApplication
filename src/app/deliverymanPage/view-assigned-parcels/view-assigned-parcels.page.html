<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/deliveryman-home"></ion-back-button>
    </ion-buttons>
    <ion-title>Assigned Parcels</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="main-container">
    <!-- Add Parcel Form -->
    <div class="card form-card">
      <div class="card-content">
        <form [formGroup]="parcelForm" (ngSubmit)="addParcel()">
          <div class="form-field">
            <ion-label>Tracking ID</ion-label>
            <div class="input-with-buttons">
              <ion-input formControlName="trackingId" placeholder="Enter tracking ID"></ion-input>
              <div class="input-buttons">
                <ion-button fill="clear" size="small" (click)="startBarcodeScanner()" [disabled]="isAddingParcel">
                  <ion-icon name="scan-outline"></ion-icon>
                </ion-button>
                <ion-button fill="clear" size="small" (click)="uploadBarcode()" [disabled]="isAddingParcel">
                  <ion-icon name="image-outline"></ion-icon>
                </ion-button>
              </div>
            </div>
            <small class="helper-text" *ngIf="parcelForm.get('trackingId')?.invalid && parcelForm.get('trackingId')?.touched">
              Please enter a valid tracking ID
            </small>
          </div>
          
          <!-- Replace the status segment in the form -->
          <div class="form-field">
            <ion-label>Status</ion-label>
            <ion-segment formControlName="status">
              <ion-segment-button value="In Transit">
                <ion-icon name="airplane-outline"></ion-icon>
                <ion-label class="small-text">In Transit</ion-label>
              </ion-segment-button>
              <ion-segment-button value="Out for Delivery">
                <ion-icon name="bicycle-outline"></ion-icon>
                <ion-label class="small-text">Out for Delivery</ion-label>
              </ion-segment-button>
            </ion-segment>
          </div>
          
          <div class="form-actions">
            <ion-button expand="block" type="submit" [disabled]="parcelForm.invalid || isAddingParcel">
              <ion-spinner *ngIf="isAddingParcel" name="crescent"></ion-spinner>
              <span *ngIf="!isAddingParcel">
                <ion-icon name="add-circle-outline" slot="start"></ion-icon>
                Add Parcel
              </span>
            </ion-button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Parcel List with adjusted header -->
    <div class="card parcels-card">
      <div class="card-header">
        <h2>
          <ion-icon name="cube-outline"></ion-icon>
          Assigned Parcels
        </h2>
        
        <!-- Replace the header-actions div in the parcels-card -->
        <div class="header-actions" *ngIf="assignedParcels.length > 0">
          <ion-button fill="clear" size="small" (click)="toggleAllParcels()">
            <ion-icon [name]="allSelected ? 'close-circle-outline' : 'checkmark-done-outline'" slot="start"></ion-icon>
            {{ allSelected ? 'Clear' : 'All' }}
          </ion-button>
        </div>
      </div>
      
      <div class="card-content">
        <!-- Loading state -->
        <div class="loading-state" *ngIf="isLoadingParcels">
          <ion-spinner name="bubbles"></ion-spinner>
          <p>Loading your assigned parcels...</p>
        </div>
        
        <!-- Empty state -->
        <div class="empty-state" *ngIf="!isLoadingParcels && assignedParcels.length === 0">
          <ion-icon name="cube-outline"></ion-icon>
          <p>No parcels assigned</p>
          <small>Assign parcels for delivery using the form above</small>
        </div>
        
        <!-- Parcel list with improved selection circles -->
        <div class="parcel-list" *ngIf="!isLoadingParcels && assignedParcels.length > 0">
          <div class="parcel-item" 
               *ngFor="let parcel of assignedParcels; let i = index" 
               [class.selected]="parcel.selected" 
               [attr.tabindex]="i">
            
            <!-- Circle selection on left side - made bigger -->
            <div class="selection-circle" (click)="toggleSelection(parcel)">
              <ion-icon [name]="parcel.selected ? 'checkmark-circle' : 'ellipse-outline'"></ion-icon>
            </div>
            
            <!-- Main content (clickable for detailed view) -->
            <div class="parcel-content">
              <div class="parcel-header">
                <div class="tracking-id">{{ parcel.trackingId }}</div>
                <div class="status-badge" [ngClass]="getStatusClass(parcel.status)">
                  {{ parcel.status || 'Pending' }}
                </div>
              </div>
              
              <div class="parcel-body">
                <div class="detail-item">
                  <ion-icon name="location-outline"></ion-icon>
                  <span>{{ parcel.receiverAddress || 'No address' }}</span>
                </div>
                
                <div class="detail-item">
                  <ion-icon name="calendar-outline"></ion-icon>
                  <span>{{ formatDate(parcel.addedDate) }}</span>
                </div>
                
                <div class="detail-item">
                  <ion-icon name="navigate-outline"></ion-icon>
                  <span>{{ formatCoordinate(parcel.locationLat) }}, {{ formatCoordinate(parcel.locationLng) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Floating action button for removing selected parcels -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="isMultiSelectMode">
    <ion-fab-button color="danger" (click)="removeSelectedParcels()">
      <ion-icon name="trash-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
  
  <!-- Hidden file input for barcode upload -->
  <input type="file" #fileInput hidden accept="image/*" (change)="processUploadedImage($event)">

  <!-- For the scanner overlay, use a non-focusing container -->
  <div class="scanner-overlay" *ngIf="isScanningBarcode" tabindex="-1">
    <div class="scanner-container">
      <div class="scanner-header">
        <h3>Scan Barcode</h3>
        <button type="button" class="close-button" (click)="stopBarcodeScanner()">
          <ion-icon name="close-outline"></ion-icon>
        </button>
      </div>
      
      <div class="scanner-viewport">
        <div #scanner></div>
        <div class="scan-region-highlight"></div>
      </div>
      
      <div class="scanner-footer">
        <p>Position the barcode within the frame</p>
      </div>
    </div>
  </div>

  <!-- Also replace the processing overlay -->
  <div class="processing-overlay" *ngIf="isProcessingImage" tabindex="-1">
    <div class="processing-content">
      <ion-spinner name="circles"></ion-spinner>
      <p>Processing image...</p>
    </div>
  </div>
</ion-content>
